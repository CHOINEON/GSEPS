import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { CommonService } from '../common/common.service';
import { ForecastService } from '../forecast/forecast.service';
import { PredictionModel } from './entities/prediction.entity';
import { PredictType } from './types/predict.type';

@Injectable()
export class PredictionService {
  constructor(
    @InjectRepository(PredictionModel)
    private predictionRepository: Repository<PredictionModel>,

    private commonService: CommonService,
    private forecastService: ForecastService,
  ) {}

  async setPredictions(time: number) {
    const forecastData = await this.forecastService.getForecast3Days(time);
    const epsTestData = await this._getRecentTestData();
    const res_predict = await this._requestPrediction(epsTestData);

    const targetDate = new Date(new Date().setHours(time, 0, 0, 0));

    const savedPredictions = await this._savePredictions(
      res_predict,
      targetDate,
    );
    return await this._matchPredictionsWithForecast(
      savedPredictions,
      forecastData,
    );
  }

  async getDailyPredictionTable(scopeDate: Date) {
    const startDate = new Date(scopeDate);
    const endDate = new Date(scopeDate);
    endDate.setDate(endDate.getDate() + 1);

    const predictions = await this.predictionRepository
      .createQueryBuilder('prediction')
      .where('prediction.time >= :startDate', { startDate })
      .andWhere('prediction.time < :endDate', { endDate })
      .orderBy('prediction.time', 'DESC')
      .getMany();

    // 온도별로 그룹화
    const groupedPredictions = predictions.reduce((acc, curr) => {
      const temp = curr.predictTemperature;
      if (!acc[temp]) {
        acc[temp] = {
          temperature: temp,
          predictions: [],
        };
      }
      acc[temp].predictions.push({
        predictionId: curr.id,
        GT1: curr.GT1,
        GT2: curr.GT2,
        ST: curr.ST,
        predictedAt: curr.time.toISOString(),
      });
      return acc;
    }, {});

    // 각 온도 그룹을 최신순으로 정렬하고 latest와 historical로 분리
    const predictionGroups = Object.values(groupedPredictions)
      .map((group: any) => ({
        temperature: group.temperature,
        latest: group.predictions[0],
        historical: group.predictions.slice(1),
      }))
      .sort((a, b) => a.temperature - b.temperature); // 온도 내림차순 정렬

    // 날짜도 KST 기준으로 변환
    const kstOffset = 9 * 60 * 60 * 1000;
    const kstDate = new Date(startDate.getTime() + kstOffset);

    return {
      date: kstDate.toISOString().split('T')[0],
      predictions: predictionGroups,
    };
  }

  private async _getRecentTestData() {
    // 최근 시험 데이터를 가져오는 로직 구현
    return [
      {
        datetime: '2024-03-12 08:10:00',
        'GT1 압축기 입구 대기온도': '6.000003815',
        'GT1 압축기 입구 대기압': '1013.662109',
        'GT1 압축기 입구 상대습도': '87.16956329',
        'GT1 헤파필터 차압': '41.34708786',
        'GT1 HCO SHAFT POSN': '3.327251673',
        'GT1 IGV POSN': '94.49976349',
        'GT1 VGV1 POSN': '94.54256439',
        'GT1 VGV2 POSN': '99.09526825',
        'GT1 VGV3 POSN': '97.78289032',
        'GT1 압축기 출구 온도': '439.0005798',
        'GT1 압축기 후단 압력': '21.61815262',
        'GT1 압축기 온도 차': '433.000575985',
        'GT1 압축비': '21.326783775440504',
        'GT1 압축기 효율': '-2.2910915398282663',
        'GT1 연료가스 유량계 온도': '7.739382267',
        'GT1 연료가스 유입량': '76.67478943',
        'GT1 연료가스 온도': '215.3217163',
        'GT1 A Stage FG FLOW': '5.188626289',
        'GT1 B Stage FG FLOW': '5.205745697',
        'GT1 C Stage FG FLOW': '2.568181992',
        'GT1 Pilot Stage FG FLOW': '0.038147319',
        'GT1 D Stage FG FLOW': '1.28535378',
        'GT1 연료 합': '14.286055076999999',
        'GT1 A Stage CV POSN': '54.91174698',
        'GT1 B Stage CV POSN': '54.23931122',
        'GT1 C Stage CV POSN': '54.07162476',
        'GT1 Pilot Stage CV POSN': '14.48929405',
        'GT1 D Stage CV POSN': '67.41863251',
        'GT1 발전량': '294.2763367',
        'GT1 연료당 발전량': '20.598852175347808',
        'GT1 OTC': '626.0657959',
        'GT1 배기구 온도': '627.0333252',
        'GT1 터빈 온도 차': '188.0327454',
        'GT1 연료당 터빈 온도 차': '13.161978193877015',
        'GT1 배기구 압력': '553.9298706',
        'GT1 터빈 압력 차': '532.3117179799999',
        'GT1 연료당 터빈 압력 차': '37.260931384550055',
        'GT1 터빈 효율': '2.8309522197722474',
        'GT1 방빙장치 Valve': '-0.354456007',
        'GT1 정비 주기 (EOH)': '53274.15625',
        'GT2 압축기 입구 대기온도': '6.08742857',
        'GT2 압축기 입구 대기압': '1013.300781',
        'GT2 압축기 입구 상대습도': '28.98248291',
        'GT2 헤파필터 차압': '40.93395996',
        'GT2 HCO SHAFT POSN': '0.38907814',
        'GT2 IGV POSN': '94.49417114',
        'GT2 VGV1 POSN': '94.49958038',
        'GT2 VGV2 POSN': '99.34710693',
        'GT2 VGV3 POSN': '98.68218231',
        'GT2 압축기 출구 온도': '439.789856',
        'GT2 압축기 후단 압력': '21.61594009',
        'GT2 압축기 온도 차': '433.70242743',
        'GT2 압축비': '21.332205101695266',
        'GT2 압축기 효율': '-2.2865558922195772',
        'GT2 연료가스 유량계 온도': '7.874168396',
        'GT2 연료가스 유입량': '76.35411835',
        'GT2 연료가스 온도': '213.9125824',
        'GT2 A Stage FG FLOW': '5.211263657',
        'GT2 B Stage FG FLOW': '5.212908268',
        'GT2 C Stage FG FLOW': '2.574734449',
        'GT2 Pilot Stage FG FLOW': '0.034866575',
        'GT2 D Stage FG FLOW': '1.309730291',
        'GT2 연료 합': '14.34350324',
        'GT2 A Stage CV POSN': '53.79273224',
        'GT2 B Stage CV POSN': '54.42647171',
        'GT2 C Stage CV POSN': '54.40538025',
        'GT2 Pilot Stage CV POSN': '14.49052429',
        'GT2 D Stage CV POSN': '68.03670502',
        'GT2 발전량': '291.0534363',
        'GT2 연료당 발전량': '20.291656189565582',
        'GT2 OTC': '631.1166382',
        'GT2 배기구 온도': '631.75',
        'GT2 터빈 온도 차': '191.960144',
        'GT2 연료당 터빈 온도 차': '13.383072516390355',
        'GT2 배기구 압력': '536.4050293',
        'GT2 터빈 압력 차': '514.78908921',
        'GT2 연료당 터빈 압력 차': '35.89005284109379',
        'GT2 터빈 효율': '2.68174985954376',
        'GT2 방빙장치 Valve': '0.151909724',
        'GT2 정비 주기 (EOH)': '50815.5',
        'HRSG1 HP TEMP': '569.7220459',
        'HRSG1 HP PRES': '168.1495972',
        'HRSG1 HP FLOW': '302.4918213',
        'HRSG2 HP TEMP': '573.0477295',
        'HRSG2 HP PRES': '167.6316376',
        'HRSG2 HP FLOW': '304.0082703',
        'ST HPS (Header) TEMP': '566.6347656',
        'ST HPS (Header) PRES': '162.7628632',
        'ST CV POSN HPS1': '102.1809692',
        'ST CV POSN HPS2': '101.9737167',
        'ST CV POSN CRH1': '100.390625',
        'ST CV POSN CRH2': '99.80830383',
        'HRSG1 IP TEMP': '339.6701355',
        'HRSG1 IP PRES': '36.94517136',
        'HRSG1 IP FLOW': '42.05183411',
        'HRSG1 HRH TEMP': '567.0682373',
        'HRSG2 IP TEMP': '340.8564758',
        'HRSG2 IP PRES': '37.22592926',
        'HRSG2 IP FLOW': '41.22511292',
        'HRSG2 HRH TEMP': '570.3939209',
        'ST IPS (Header) TEMP': '568.0333252',
        'ST IPS (Header) PRES': '34.5060463',
        'ST CV POSN IPS1': '99.90660095',
        'ST CV POSN IPS2': '99.74694824',
        'HRSG1 LP TEMP': '284.0205383',
        'HRSG1 LP PRES': '3.808924198',
        'HRSG1 LP FLOW': '30.487854',
        'HRSG2 LP TEMP': '283.9699097',
        'HRSG2 LP PRES': '3.778645754',
        'HRSG2 LP FLOW': '29.32675362',
        'ST LPS (Header) TEMP': '278.2000122',
        'ST LPS (Header) PRES': '3.56936717',
        'ST CV POSN LPS': '100.0453796',
        'ST 콘덴서 입구 해수온도1': '5.523003578',
        'ST 콘덴서 출구 해수온도1': '21.80121613',
        'ST 콘덴서 입구 해수온도2': '5.609809399',
        'ST 콘덴서 출구 해수온도2': '21.23047066',
        'ST 콘덴서 압력': '0.04076495',
        'ST 발전량': '0',
      },
      {
        datetime: '2024-03-12 08:11:00',
        'GT1 압축기 입구 대기온도': '6.000003815',
        'GT1 압축기 입구 대기압': '1013.662109',
        'GT1 압축기 입구 상대습도': '87.39247131',
        'GT1 헤파필터 차압': '41.38482285',
        'GT1 HCO SHAFT POSN': '3.327535152',
        'GT1 IGV POSN': '94.49976349',
        'GT1 VGV1 POSN': '94.52413177',
        'GT1 VGV2 POSN': '99.08596802',
        'GT1 VGV3 POSN': '97.79980469',
        'GT1 압축기 출구 온도': '438.8781433',
        'GT1 압축기 후단 압력': '21.61815262',
        'GT1 압축기 온도 차': '432.87813948499996',
        'GT1 압축비': '21.326783775440504',
        'GT1 압축기 효율': '-2.2917395587595295',
        'GT1 연료가스 유량계 온도': '7.741970062',
        'GT1 연료가스 유입량': '76.66838074',
        'GT1 연료가스 온도': '215.2542419',
        'GT1 A Stage FG FLOW': '5.198543072',
        'GT1 B Stage FG FLOW': '5.199899197',
        'GT1 C Stage FG FLOW': '2.568181992',
        'GT1 Pilot Stage FG FLOW': '0.038147319',
        'GT1 D Stage FG FLOW': '1.28535378',
        'GT1 연료 합': '14.29012536',
        'GT1 A Stage CV POSN': '54.91174698',
        'GT1 B Stage CV POSN': '54.23900604',
        'GT1 C Stage CV POSN': '54.07569122',
        'GT1 Pilot Stage CV POSN': '14.48929405',
        'GT1 D Stage CV POSN': '67.41513062',
        'GT1 발전량': '294.3343811',
        'GT1 연료당 발전량': '20.597046819748822',
        'GT1 OTC': '626.0657959',
        'GT1 배기구 온도': '627.0333252',
        'GT1 터빈 온도 차': '188.15518190000006',
        'GT1 연료당 터빈 온도 차': '13.166797152575858',
        'GT1 배기구 압력': '557.1998901',
        'GT1 터빈 압력 차': '535.5817374799999',
        'GT1 연료당 터빈 압력 차': '37.4791489918742',
        'GT1 터빈 효율': '2.8464894353249792',
        'GT1 방빙장치 Valve': '-0.354456007',
        'GT1 정비 주기 (EOH)': '53274.17578',
        'GT2 압축기 입구 대기온도': '6.103291512',
        'GT2 압축기 입구 대기압': '1013.300781',
        'GT2 압축기 입구 상대습도': '29.29888344',
        'GT2 헤파필터 차압': '41.13815308',
        'GT2 HCO SHAFT POSN': '0.387219936',
        'GT2 IGV POSN': '94.49332428',
        'GT2 VGV1 POSN': '94.47058868',
        'GT2 VGV2 POSN': '99.29073334',
        'GT2 VGV3 POSN': '98.69030762',
        'GT2 압축기 출구 온도': '439.7581482',
        'GT2 압축기 후단 압력': '21.61594009',
        'GT2 압축기 온도 차': '433.654856688',
        'GT2 압축비': '21.332205101695266',
        'GT2 압축기 효율': '-2.2868067210959055',
        'GT2 연료가스 유량계 온도': '7.874168396',
        'GT2 연료가스 유입량': '76.35272217',
        'GT2 연료가스 온도': '213.8744202',
        'GT2 A Stage FG FLOW': '5.211263657',
        'GT2 B Stage FG FLOW': '5.209572792',
        'GT2 C Stage FG FLOW': '2.572548389',
        'GT2 Pilot Stage FG FLOW': '0.034866575',
        'GT2 D Stage FG FLOW': '1.310102105',
        'GT2 연료 합': '14.338353518',
        'GT2 A Stage CV POSN': '53.79050827',
        'GT2 B Stage CV POSN': '54.42850113',
        'GT2 C Stage CV POSN': '54.40538025',
        'GT2 Pilot Stage CV POSN': '14.48929405',
        'GT2 D Stage CV POSN': '68.03824615',
        'GT2 발전량': '291.2466431',
        'GT2 연료당 발전량': '20.312418907399405',
        'GT2 OTC': '631.0256958',
        'GT2 배기구 온도': '631.75',
        'GT2 터빈 온도 차': '191.9918518',
        'GT2 연료당 터빈 온도 차': '13.390090539961815',
        'GT2 배기구 압력': '539.1609497',
        'GT2 터빈 압력 차': '517.54500961',
        'GT2 연료당 터빈 압력 차': '36.09514920665663',
        'GT2 터빈 효율': '2.695661324987543',
        'GT2 방빙장치 Valve': '0.151909724',
        'GT2 정비 주기 (EOH)': '50815.5',
        'HRSG1 HP TEMP': '569.4816284',
        'HRSG1 HP PRES': '168.1495972',
        'HRSG1 HP FLOW': '302.3466797',
        'HRSG2 HP TEMP': '572.8873291',
        'HRSG2 HP PRES': '167.6356506',
        'HRSG2 HP FLOW': '304.1348877',
        'ST HPS (Header) TEMP': '566.5',
        'ST HPS (Header) PRES': '162.7628632',
        'ST CV POSN HPS1': '102.1809692',
        'ST CV POSN HPS2': '101.9737167',
        'ST CV POSN CRH1': '100.390625',
        'ST CV POSN CRH2': '99.80830383',
        'HRSG1 IP TEMP': '339.6701355',
        'HRSG1 IP PRES': '36.94517136',
        'HRSG1 IP FLOW': '42.12139893',
        'HRSG1 HRH TEMP': '566.8822021',
        'HRSG2 IP TEMP': '340.8564758',
        'HRSG2 IP PRES': '37.23923874',
        'HRSG2 IP FLOW': '41.24298096',
        'HRSG2 HRH TEMP': '570.3928833',
        'ST IPS (Header) TEMP': '568.0333252',
        'ST IPS (Header) PRES': '34.5060463',
        'ST CV POSN IPS1': '99.90660095',
        'ST CV POSN IPS2': '99.74694824',
        'HRSG1 LP TEMP': '284.0259705',
        'HRSG1 LP PRES': '3.807177544',
        'HRSG1 LP FLOW': '30.4873085',
        'HRSG2 LP TEMP': '283.9699097',
        'HRSG2 LP PRES': '3.778645754',
        'HRSG2 LP FLOW': '29.30035019',
        'ST LPS (Header) TEMP': '278.2000122',
        'ST LPS (Header) PRES': '3.56822896',
        'ST CV POSN LPS': '100.054306',
        'ST 콘덴서 입구 해수온도1': '5.523003578',
        'ST 콘덴서 출구 해수온도1': '21.80121613',
        'ST 콘덴서 입구 해수온도2': '5.609809399',
        'ST 콘덴서 출구 해수온도2': '21.23047066',
        'ST 콘덴서 압력': '0.04076495',
        'ST 발전량': '0',
      },
      {
        datetime: '2024-03-12 08:12:00',
        'GT1 압축기 입구 대기온도': '6.031755447',
        'GT1 압축기 입구 대기압': '1013.662109',
        'GT1 압축기 입구 상대습도': '87.64877319',
        'GT1 헤파필터 차압': '41.46666336',
        'GT1 HCO SHAFT POSN': '3.328740358',
        'GT1 IGV POSN': '94.49976349',
        'GT1 VGV1 POSN': '94.50434113',
        'GT1 VGV2 POSN': '99.06991577',
        'GT1 VGV3 POSN': '97.81167603',
        'GT1 압축기 출구 온도': '439.0089722',
        'GT1 압축기 후단 압력': '21.61815262',
        'GT1 압축기 온도 차': '432.977216753',
        'GT1 압축비': '21.326783775440504',
        'GT1 압축기 효율': '-2.291215144805021',
        'GT1 연료가스 유량계 온도': '7.741970062',
        'GT1 연료가스 유입량': '76.66200256',
        'GT1 연료가스 온도': '215.2271423',
        'GT1 A Stage FG FLOW': '5.202737331',
        'GT1 B Stage FG FLOW': '5.200174332',
        'GT1 C Stage FG FLOW': '2.568181992',
        'GT1 Pilot Stage FG FLOW': '0.038147319',
        'GT1 D Stage FG FLOW': '1.28535378',
        'GT1 연료 합': '14.294594753999998',
        'GT1 A Stage CV POSN': '54.90528488',
        'GT1 B Stage CV POSN': '54.23723221',
        'GT1 C Stage CV POSN': '54.06573868',
        'GT1 Pilot Stage CV POSN': '14.48929405',
        'GT1 D Stage CV POSN': '67.41007233',
        'GT1 발전량': '294.5197754',
        'GT1 연료당 발전량': '20.6035764195124',
        'GT1 OTC': '626.0657959',
        'GT1 배기구 온도': '627.0333252',
        'GT1 터빈 온도 차': '188.02435300000002',
        'GT1 연료당 터빈 온도 차': '13.153528045794088',
        'GT1 배기구 압력': '558.8170166',
        'GT1 터빈 압력 차': '537.1988639799999',
        'GT1 연료당 터빈 압력 차': '37.5805591711285',
        'GT1 터빈 효율': '2.8570706688191603',
        'GT1 방빙장치 Valve': '-0.354456007',
        'GT1 정비 주기 (EOH)': '53274.21484',
        'GT2 압축기 입구 대기온도': '6.024011135',
        'GT2 압축기 입구 대기압': '1013.300781',
        'GT2 압축기 입구 상대습도': '29.6529789',
        'GT2 헤파필터 차압': '41.16213989',
        'GT2 HCO SHAFT POSN': '0.387151241',
        'GT2 IGV POSN': '94.49580383',
        'GT2 VGV1 POSN': '94.47946167',
        'GT2 VGV2 POSN': '99.3130722',
        'GT2 VGV3 POSN': '98.68744659',
        'GT2 압축기 출구 온도': '439.7046204',
        'GT2 압축기 후단 압력': '21.61594009',
        'GT2 압축기 온도 차': '433.680609265',
        'GT2 압축비': '21.332205101695266',
        'GT2 압축기 효율': '-2.2866709272307637',
        'GT2 연료가스 유량계 온도': '7.874168396',
        'GT2 연료가스 유입량': '76.35272217',
        'GT2 연료가스 온도': '213.8958282',
        'GT2 A Stage FG FLOW': '5.211263657',
        'GT2 B Stage FG FLOW': '5.209770679',
        'GT2 C Stage FG FLOW': '2.573230743',
        'GT2 Pilot Stage FG FLOW': '0.034866575',
        'GT2 D Stage FG FLOW': '1.309473634',
        'GT2 연료 합': '14.338605288',
        'GT2 A Stage CV POSN': '53.79050827',
        'GT2 B Stage CV POSN': '54.43154526',
        'GT2 C Stage CV POSN': '54.40538025',
        'GT2 Pilot Stage CV POSN': '14.48975182',
        'GT2 D Stage CV POSN': '68.04814148',
        'GT2 발전량': '290.9620972',
        'GT2 연료당 발전량': '20.292217503435054',
        'GT2 OTC': '630.9890137',
        'GT2 배기구 온도': '631.75',
        'GT2 터빈 온도 차': '192.0453796',
        'GT2 연료당 터빈 온도 차': '13.393588549419311',
        'GT2 배기구 압력': '539.3110962',
        'GT2 터빈 압력 차': '517.69515611',
        'GT2 연료당 터빈 압력 차': '36.10498690156844',
        'GT2 터빈 효율': '2.695691805698615',
        'GT2 방빙장치 Valve': '0.151909724',
        'GT2 정비 주기 (EOH)': '50815.50781',
        'HRSG1 HP TEMP': '569.4434204',
        'HRSG1 HP PRES': '168.1151123',
        'HRSG1 HP FLOW': '302.2588501',
        'HRSG2 HP TEMP': '572.8624268',
        'HRSG2 HP PRES': '167.565033',
        'HRSG2 HP FLOW': '304.1348877',
        'ST HPS (Header) TEMP': '566.5',
        'ST HPS (Header) PRES': '162.7214661',
        'ST CV POSN HPS1': '102.1809692',
        'ST CV POSN HPS2': '101.9749146',
        'ST CV POSN CRH1': '100.390625',
        'ST CV POSN CRH2': '99.80830383',
        'HRSG1 IP TEMP': '339.6701355',
        'HRSG1 IP PRES': '36.94517136',
        'HRSG1 IP FLOW': '42.25807571',
        'HRSG1 HRH TEMP': '566.8674316',
        'HRSG2 IP TEMP': '340.8564758',
        'HRSG2 IP PRES': '37.23807526',
        'HRSG2 IP FLOW': '41.28966904',
        'HRSG2 HRH TEMP': '570.2941895',
        'ST IPS (Header) TEMP': '568.0211792',
        'ST IPS (Header) PRES': '34.5060463',
        'ST CV POSN IPS1': '99.90660095',
        'ST CV POSN IPS2': '99.74694824',
        'HRSG1 LP TEMP': '284.1263428',
        'HRSG1 LP PRES': '3.805602074',
        'HRSG1 LP FLOW': '30.4873085',
        'HRSG2 LP TEMP': '283.9699097',
        'HRSG2 LP PRES': '3.778634787',
        'HRSG2 LP FLOW': '29.29847717',
        'ST LPS (Header) TEMP': '278.2000122',
        'ST LPS (Header) PRES': '3.566036701',
        'ST CV POSN LPS': '100.0578766',
        'ST 콘덴서 입구 해수온도1': '5.523003578',
        'ST 콘덴서 출구 해수온도1': '21.80121613',
        'ST 콘덴서 입구 해수온도2': '5.609809399',
        'ST 콘덴서 출구 해수온도2': '21.23047066',
        'ST 콘덴서 압력': '0.04076495',
        'ST 발전량': '0',
      },
      {
        datetime: '2024-03-12 08:13:00',
        'GT1 압축기 입구 대기온도': '6.095714569',
        'GT1 압축기 입구 대기압': '1013.662109',
        'GT1 압축기 입구 상대습도': '87.88272095',
        'GT1 헤파필터 차압': '41.56977844',
        'GT1 HCO SHAFT POSN': '3.325430393',
        'GT1 IGV POSN': '94.49976349',
        'GT1 VGV1 POSN': '94.48558044',
        'GT1 VGV2 POSN': '99.06959534',
        'GT1 VGV3 POSN': '97.80523682',
        'GT1 압축기 출구 온도': '439.2788086',
        'GT1 압축기 후단 압력': '21.61815262',
        'GT1 압축기 온도 차': '433.183094031',
        'GT1 압축비': '21.326783775440504',
        'GT1 압축기 효율': '-2.2901262077162365',
        'GT1 연료가스 유량계 온도': '7.741970062',
        'GT1 연료가스 유입량': '76.64987946',
        'GT1 연료가스 온도': '215.2271423',
        'GT1 A Stage FG FLOW': '5.214651108',
        'GT1 B Stage FG FLOW': '5.200577259',
        'GT1 C Stage FG FLOW': '2.568181992',
        'GT1 Pilot Stage FG FLOW': '0.038147319',
        'GT1 D Stage FG FLOW': '1.28535378',
        'GT1 연료 합': '14.306911458',
        'GT1 A Stage CV POSN': '54.89227295',
        'GT1 B Stage CV POSN': '54.22838593',
        'GT1 C Stage CV POSN': '54.06400299',
        'GT1 Pilot Stage CV POSN': '14.48929405',
        'GT1 D Stage CV POSN': '67.40113068',
        'GT1 발전량': '294.1838684',
        'GT1 연료당 발전량': '20.562360315405538',
        'GT1 OTC': '626.0657959',
        'GT1 배기구 온도': '627.0333252',
        'GT1 터빈 온도 차': '187.75451660000004',
        'GT1 연료당 터빈 온도 차': '13.123343717557804',
        'GT1 배기구 압력': '553.1713257',
        'GT1 터빈 압력 차': '531.55317308',
        'GT1 연료당 터빈 압력 차': '37.15359353697343',
        'GT1 터빈 효율': '2.831107249539263',
        'GT1 방빙장치 Valve': '-0.354456007',
        'GT1 정비 주기 (EOH)': '53274.22266',
        'GT2 압축기 입구 대기온도': '5.985492229',
        'GT2 압축기 입구 대기압': '1013.300781',
        'GT2 압축기 입구 상대습도': '30.12040901',
        'GT2 헤파필터 차압': '41.11392975',
        'GT2 HCO SHAFT POSN': '0.389413029',
        'GT2 IGV POSN': '94.51773071',
        'GT2 VGV1 POSN': '94.48265076',
        'GT2 VGV2 POSN': '99.35238647',
        'GT2 VGV3 POSN': '98.68061829',
        'GT2 압축기 출구 온도': '439.7000122',
        'GT2 압축기 후단 압력': '21.61975098',
        'GT2 압축기 온도 차': '433.714519971',
        'GT2 압축비': '21.335965969219952',
        'GT2 압축기 효율': '-2.286483353350282',
        'GT2 연료가스 유량계 온도': '7.869206429',
        'GT2 연료가스 유입량': '76.35272217',
        'GT2 연료가스 온도': '214.0854034',
        'GT2 A Stage FG FLOW': '5.211263657',
        'GT2 B Stage FG FLOW': '5.212097168',
        'GT2 C Stage FG FLOW': '2.572572947',
        'GT2 Pilot Stage FG FLOW': '0.034866575',
        'GT2 D Stage FG FLOW': '1.309798837',
        'GT2 연료 합': '14.340599184',
        'GT2 A Stage CV POSN': '53.79218292',
        'GT2 B Stage CV POSN': '54.42751694',
        'GT2 C Stage CV POSN': '54.4058342',
        'GT2 Pilot Stage CV POSN': '14.49380684',
        'GT2 D Stage CV POSN': '68.04462433',
        'GT2 발전량': '291.1086121',
        'GT2 연료당 발전량': '20.299612893776',
        'GT2 OTC': '630.9906616',
        'GT2 배기구 온도': '631.75',
        'GT2 터빈 온도 차': '192.0499878',
        'GT2 연료당 터빈 온도 차': '13.392047663829329',
        'GT2 배기구 압력': '540.0251465',
        'GT2 터빈 압력 차': '518.40539552',
        'GT2 연료당 터빈 압력 차': '36.149493397625385',
        'GT2 터빈 효율': '2.699325323883202',
        'GT2 방빙장치 Valve': '0.151909724',
        'GT2 정비 주기 (EOH)': '50815.54688',
        'HRSG1 HP TEMP': '569.3145142',
        'HRSG1 HP PRES': '168.0078278',
        'HRSG1 HP FLOW': '301.9700928',
        'HRSG2 HP TEMP': '572.7611694',
        'HRSG2 HP PRES': '167.522583',
        'HRSG2 HP FLOW': '304.1440735',
        'ST HPS (Header) TEMP': '566.5',
        'ST HPS (Header) PRES': '162.638443',
        'ST CV POSN HPS1': '102.1809692',
        'ST CV POSN HPS2': '101.9819183',
        'ST CV POSN CRH1': '100.390625',
        'ST CV POSN CRH2': '99.80830383',
        'HRSG1 IP TEMP': '339.6701355',
        'HRSG1 IP PRES': '36.94411087',
        'HRSG1 IP FLOW': '42.26346588',
        'HRSG1 HRH TEMP': '566.861084',
        'HRSG2 IP TEMP': '340.8580017',
        'HRSG2 IP PRES': '37.2246933',
        'HRSG2 IP FLOW': '41.34750366',
        'HRSG2 HRH TEMP': '570.1619873',
        'ST IPS (Header) TEMP': '567.7766724',
        'ST IPS (Header) PRES': '34.5060463',
        'ST CV POSN IPS1': '99.90660095',
        'ST CV POSN IPS2': '99.74694824',
        'HRSG1 LP TEMP': '284.2199097',
        'HRSG1 LP PRES': '3.805555582',
        'HRSG1 LP FLOW': '30.49423218',
        'HRSG2 LP TEMP': '283.9699097',
        'HRSG2 LP PRES': '3.777263165',
        'HRSG2 LP FLOW': '29.28797913',
        'ST LPS (Header) TEMP': '278.2000122',
        'ST LPS (Header) PRES': '3.565681934',
        'ST CV POSN LPS': '100.0578766',
        'ST 콘덴서 입구 해수온도1': '5.523003578',
        'ST 콘덴서 출구 해수온도1': '21.80121613',
        'ST 콘덴서 입구 해수온도2': '5.609809399',
        'ST 콘덴서 출구 해수온도2': '21.23047066',
        'ST 콘덴서 압력': '0.04076495',
        'ST 발전량': '0',
      },
      {
        datetime: '2024-03-12 08:14:00',
        'GT1 압축기 입구 대기온도': '6.106665134',
        'GT1 압축기 입구 대기압': '1013.662109',
        'GT1 압축기 입구 상대습도': '87.890625',
        'GT1 헤파필터 차압': '41.53225327',
        'GT1 HCO SHAFT POSN': '3.328804255',
        'GT1 IGV POSN': '94.49976349',
        'GT1 VGV1 POSN': '94.5092392',
        'GT1 VGV2 POSN': '99.06959534',
        'GT1 VGV3 POSN': '97.82276917',
        'GT1 압축기 출구 온도': '439.3250122',
        'GT1 압축기 후단 압력': '21.61815262',
        'GT1 압축기 온도 차': '433.218347066',
        'GT1 압축비': '21.326783775440504',
        'GT1 압축기 효율': '-2.2899398492669656',
        'GT1 연료가스 유량계 온도': '7.741970062',
        'GT1 연료가스 유입량': '76.63597107',
        'GT1 연료가스 온도': '215.2271423',
        'GT1 A Stage FG FLOW': '5.203845024',
        'GT1 B Stage FG FLOW': '5.195671558',
        'GT1 C Stage FG FLOW': '2.568181992',
        'GT1 Pilot Stage FG FLOW': '0.038147319',
        'GT1 D Stage FG FLOW': '1.285195589',
        'GT1 연료 합': '14.291041482',
        'GT1 A Stage CV POSN': '54.89004517',
        'GT1 B Stage CV POSN': '54.2245369',
        'GT1 C Stage CV POSN': '54.05947876',
        'GT1 Pilot Stage CV POSN': '14.48929405',
        'GT1 D Stage CV POSN': '67.39929199',
        'GT1 발전량': '294.2716064',
        'GT1 연료당 발전량': '20.59133386259105',
        'GT1 OTC': '626.0657959',
        'GT1 배기구 온도': '627.0333252',
        'GT1 터빈 온도 차': '187.70831300000003',
        'GT1 연료당 터빈 온도 차': '13.134683937236089',
        'GT1 배기구 압력': '558.59198',
        'GT1 터빈 압력 차': '536.97382738',
        'GT1 연료당 터빈 압력 차': '37.5741563731611',
        'GT1 터빈 효율': '2.860682187154918',
        'GT1 방빙장치 Valve': '-0.354456007',
        'GT1 정비 주기 (EOH)': '53274.22266',
        'GT2 압축기 입구 대기온도': '5.961759567',
        'GT2 압축기 입구 대기압': '1013.300781',
        'GT2 압축기 입구 상대습도': '30.46087456',
        'GT2 헤파필터 차압': '41.12989426',
        'GT2 HCO SHAFT POSN': '0.387200207',
        'GT2 IGV POSN': '94.5005188',
        'GT2 VGV1 POSN': '94.47853851',
        'GT2 VGV2 POSN': '99.33615112',
        'GT2 VGV3 POSN': '98.67989349',
        'GT2 압축기 출구 온도': '439.7001343',
        'GT2 압축기 후단 압력': '21.62777138',
        'GT2 압축기 온도 차': '433.738374733',
        'GT2 압축비': '21.34388109190651',
        'GT2 압축기 효율': '-2.2863391099080235',
        'GT2 연료가스 유량계 온도': '7.755682945',
        'GT2 연료가스 유입량': '76.35272217',
        'GT2 연료가스 온도': '214.2121429',
        'GT2 A Stage FG FLOW': '5.211263657',
        'GT2 B Stage FG FLOW': '5.213113308',
        'GT2 C Stage FG FLOW': '2.574432373',
        'GT2 Pilot Stage FG FLOW': '0.034866575',
        'GT2 D Stage FG FLOW': '1.310498118',
        'GT2 연료 합': '14.344174031000001',
        'GT2 A Stage CV POSN': '53.80097961',
        'GT2 B Stage CV POSN': '54.43431854',
        'GT2 C Stage CV POSN': '54.41624069',
        'GT2 Pilot Stage CV POSN': '14.49612331',
        'GT2 D Stage CV POSN': '68.04749298',
        'GT2 발전량': '291.0354919',
        'GT2 연료당 발전량': '20.289456281764767',
        'GT2 OTC': '631.0283203',
        'GT2 배기구 온도': '631.75',
        'GT2 터빈 온도 차': '192.0498657',
        'GT2 연료당 터빈 온도 차': '13.388701593061421',
        'GT2 배기구 압력': '539.4674072',
        'GT2 터빈 압력 차': '517.83963582',
        'GT2 연료당 터빈 압력 차': '36.10104246510588',
        'GT2 터빈 효율': '2.6963811400363817',
        'GT2 방빙장치 Valve': '0.145917997',
        'GT2 정비 주기 (EOH)': '50815.56641',
        'HRSG1 HP TEMP': '569.1364136',
        'HRSG1 HP PRES': '167.9777985',
        'HRSG1 HP FLOW': '301.6053162',
        'HRSG2 HP TEMP': '572.5482178',
        'HRSG2 HP PRES': '167.483017',
        'HRSG2 HP FLOW': '304.3543396',
        'ST HPS (Header) TEMP': '566.4991455',
        'ST HPS (Header) PRES': '162.6243134',
        'ST CV POSN HPS1': '102.1809692',
        'ST CV POSN HPS2': '101.9850311',
        'ST CV POSN CRH1': '100.390625',
        'ST CV POSN CRH2': '99.80830383',
        'HRSG1 IP TEMP': '339.6701355',
        'HRSG1 IP PRES': '36.93416977',
        'HRSG1 IP FLOW': '42.32733154',
        'HRSG1 HRH TEMP': '566.7177734',
        'HRSG2 IP TEMP': '340.8926697',
        'HRSG2 IP PRES': '37.21574783',
        'HRSG2 IP FLOW': '41.26582718',
        'HRSG2 HRH TEMP': '570.1497803',
        'ST IPS (Header) TEMP': '567.5421753',
        'ST IPS (Header) PRES': '34.5060463',
        'ST CV POSN IPS1': '99.90660095',
        'ST CV POSN IPS2': '99.74694824',
        'HRSG1 LP TEMP': '284.2230835',
        'HRSG1 LP PRES': '3.805555582',
        'HRSG1 LP FLOW': '30.51676559',
        'HRSG2 LP TEMP': '283.9908752',
        'HRSG2 LP PRES': '3.7753613',
        'HRSG2 LP FLOW': '29.2773056',
        'ST LPS (Header) TEMP': '278.2000122',
        'ST LPS (Header) PRES': '3.565681934',
        'ST CV POSN LPS': '100.0578766',
        'ST 콘덴서 입구 해수온도1': '5.523003578',
        'ST 콘덴서 출구 해수온도1': '21.80121613',
        'ST 콘덴서 입구 해수온도2': '5.609809399',
        'ST 콘덴서 출구 해수온도2': '21.23047066',
        'ST 콘덴서 압력': '0.04076495',
        'ST 발전량': '0',
      },
      {
        datetime: '2024-03-12 08:15:00',
        'GT1 압축기 입구 대기온도': '6.10632658',
        'GT1 압축기 입구 대기압': '1013.662903',
        'GT1 압축기 입구 상대습도': '87.890625',
        'GT1 헤파필터 차압': '41.63600922',
        'GT1 HCO SHAFT POSN': '3.326874256',
        'GT1 IGV POSN': '94.49976349',
        'GT1 VGV1 POSN': '94.49655151',
        'GT1 VGV2 POSN': '99.06959534',
        'GT1 VGV3 POSN': '97.82276917',
        'GT1 압축기 출구 온도': '439.3250122',
        'GT1 압축기 후단 압력': '21.61815262',
        'GT1 압축기 온도 차': '433.21868562000003',
        'GT1 압축비': '21.326767070216043',
        'GT1 압축기 효율': '-2.289939892505415',
        'GT1 연료가스 유량계 온도': '7.741970062',
        'GT1 연료가스 유입량': '76.6276474',
        'GT1 연료가스 온도': '215.2271423',
        'GT1 A Stage FG FLOW': '5.189621925',
        'GT1 B Stage FG FLOW': '5.194247246',
        'GT1 C Stage FG FLOW': '2.568181992',
        'GT1 Pilot Stage FG FLOW': '0.038147319',
        'GT1 D Stage FG FLOW': '1.284660816',
        'GT1 연료 합': '14.274859298',
        'GT1 A Stage CV POSN': '54.89004517',
        'GT1 B Stage CV POSN': '54.2245369',
        'GT1 C Stage CV POSN': '54.05815887',
        'GT1 Pilot Stage CV POSN': '14.48929405',
        'GT1 D Stage CV POSN': '67.40331268',
        'GT1 발전량': '294.4577942',
        'GT1 연료당 발전량': '20.627719548959437',
        'GT1 OTC': '626.0657959',
        'GT1 배기구 온도': '627.0333252',
        'GT1 터빈 온도 차': '187.70831300000003',
        'GT1 연료당 터빈 온도 차': '13.149573602192994',
        'GT1 배기구 압력': '558.1259155',
        'GT1 터빈 압력 차': '536.50776288',
        'GT1 연료당 터빈 압력 차': '37.5841016489156',
        'GT1 터빈 효율': '2.8581992683509965',
        'GT1 방빙장치 Valve': '-0.354456007',
        'GT1 정비 주기 (EOH)': '53274.24219',
        'GT2 압축기 입구 대기온도': '5.961672783',
        'GT2 압축기 입구 대기압': '1013.300781',
        'GT2 압축기 입구 상대습도': '30.74939346',
        'GT2 헤파필터 차압': '41.21627808',
        'GT2 HCO SHAFT POSN': '0.386488914',
        'GT2 IGV POSN': '94.51130676',
        'GT2 VGV1 POSN': '94.5019455',
        'GT2 VGV2 POSN': '99.36146545',
        'GT2 VGV3 POSN': '98.66732025',
        'GT2 압축기 출구 온도': '439.728302',
        'GT2 압축기 후단 압력': '21.62921906',
        'GT2 압축기 온도 차': '433.766629217',
        'GT2 압축비': '21.345309769380314',
        'GT2 압축기 효율': '-2.2861868459777193',
        'GT2 연료가스 유량계 온도': '7.642341137',
        'GT2 연료가스 유입량': '76.35272217',
        'GT2 연료가스 온도': '214.235321',
        'GT2 A Stage FG FLOW': '5.212029457',
        'GT2 B Stage FG FLOW': '5.213113308',
        'GT2 C Stage FG FLOW': '2.574569941',
        'GT2 Pilot Stage FG FLOW': '0.034866575',
        'GT2 D Stage FG FLOW': '1.311801076',
        'GT2 연료 합': '14.346380357000001',
        'GT2 A Stage CV POSN': '53.80497742',
        'GT2 B Stage CV POSN': '54.43625641',
        'GT2 C Stage CV POSN': '54.42535782',
        'GT2 Pilot Stage CV POSN': '14.49216557',
        'GT2 D Stage CV POSN': '68.05367279',
        'GT2 발전량': '291.1732483',
        'GT2 연료당 발전량': '20.29593814288692',
        'GT2 OTC': '631.0658569',
        'GT2 배기구 온도': '631.75',
        'GT2 터빈 온도 차': '192.02169800000001',
        'GT2 연료당 터빈 온도 차': '13.384679147051001',
        'GT2 배기구 압력': '539.7526855',
        'GT2 터빈 압력 차': '518.12346644',
        'GT2 연료당 터빈 압력 차': '36.11527462306498',
        'GT2 터빈 효율': '2.6982547901435594',
        'GT2 방빙장치 Valve': '0.125573978',
        'GT2 정비 주기 (EOH)': '50815.56641',
        'HRSG1 HP TEMP': '569.1189575',
        'HRSG1 HP PRES': '167.9777985',
        'HRSG1 HP FLOW': '301.4932556',
        'HRSG2 HP TEMP': '572.5095215',
        'HRSG2 HP PRES': '167.4713745',
        'HRSG2 HP FLOW': '304.5638733',
        'ST HPS (Header) TEMP': '566.2976074',
        'ST HPS (Header) PRES': '162.6100311',
        'ST CV POSN HPS1': '102.1809692',
        'ST CV POSN HPS2': '101.9850311',
        'ST CV POSN CRH1': '100.390625',
        'ST CV POSN CRH2': '99.80830383',
        'HRSG1 IP TEMP': '339.6701355',
        'HRSG1 IP PRES': '36.92730331',
        'HRSG1 IP FLOW': '42.46398163',
        'HRSG1 HRH TEMP': '566.5751343',
        'HRSG2 IP TEMP': '340.9273071',
        'HRSG2 IP PRES': '37.2157135',
        'HRSG2 IP FLOW': '41.25004196',
        'HRSG2 HRH TEMP': '570.1497803',
        'ST IPS (Header) TEMP': '567.5333252',
        'ST IPS (Header) PRES': '34.5060463',
        'ST CV POSN IPS1': '99.90660095',
        'ST CV POSN IPS2': '99.74694824',
        'HRSG1 LP TEMP': '284.2230835',
        'HRSG1 LP PRES': '3.805555582',
        'HRSG1 LP FLOW': '30.54049301',
        'HRSG2 LP TEMP': '284.0620728',
        'HRSG2 LP PRES': '3.775173664',
        'HRSG2 LP FLOW': '29.24054527',
        'ST LPS (Header) TEMP': '278.2000122',
        'ST LPS (Header) PRES': '3.565681934',
        'ST CV POSN LPS': '100.0578766',
        'ST 콘덴서 입구 해수온도1': '5.523003578',
        'ST 콘덴서 출구 해수온도1': '21.80121613',
        'ST 콘덴서 입구 해수온도2': '5.609809399',
        'ST 콘덴서 출구 해수온도2': '21.23047066',
        'ST 콘덴서 압력': '0.04076495',
        'ST 발전량': '0',
      },
    ];
  }

  private async _savePredictions(res_predict: PredictType[], targetDate: Date) {
    const existingPredictions = await this.predictionRepository.find({
      where: { time: targetDate },
    });

    return await Promise.all(
      res_predict.map(async (prediction) => {
        const existingPrediction = existingPredictions.find(
          (ep) => ep.predictTemperature === prediction.temperature,
        );

        if (existingPrediction) {
          const updatedPrediction = this.predictionRepository.merge(
            existingPrediction,
            {
              GT1: prediction.GT1,
              GT2: prediction.GT2,
              ST: prediction.ST,
            },
          );
          return this.predictionRepository.save(updatedPrediction);
        } else {
          const newPrediction = this.predictionRepository.create({
            time: targetDate,
            predictTemperature: prediction.temperature,
            GT1: prediction.GT1,
            GT2: prediction.GT2,
            ST: prediction.ST,
          });
          return this.predictionRepository.save(newPrediction);
        }
      }),
    );
  }

  private async _matchPredictionsWithForecast(
    savedPredictions: any[],
    forecastData: any[],
  ) {
    const matchingPromises = savedPredictions.map((prediction) => {
      const matchingForecasts = forecastData.filter(
        (forecast) => forecast.temperature === prediction.predictTemperature,
      );

      if (matchingForecasts.length > 0) {
        prediction.forecastData = matchingForecasts;
        return this.predictionRepository.save(prediction);
      }
      return Promise.resolve(prediction);
    });

    return await Promise.all(matchingPromises);
  }

  private async _requestPrediction(
    forecastData: any[],
  ): Promise<PredictType[]> {
    // Python 서버에 예측 요청
    const predictions = await this.commonService.getPredictData(forecastData);
    return predictions.predict;
  }
}
